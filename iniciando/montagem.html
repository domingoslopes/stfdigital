<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
        <meta content="IE=edge" http-equiv="X-UA-Compatible">
        
        <title>STF Digital Developers | Arquitetura</title>
        
        <!-- STYLESHEETS -->
        <link rel="stylesheet" href="assets/styles/fonts.css" type="text/css" >
        <link rel="stylesheet" href="assets/styles/fonts1.css" title="roboto" type="text/css">
        
        <link href="assets/styles/default.css" rel="stylesheet" type="text/css">
    </head>

    <body class="gc-documentation develop guide  dac-nav-open" itemscope="" itemtype="http://schema.org/Article">
        <header id="header-wrapper">
            <div class="dac-header" id="header">
                <div class="dac-header-inner">
                    <a class="dac-nav-toggle" data-dac-toggle-nav="" href="../index.html" title="Open navigation"> 
                        <span class="dac-nav-hamburger"> 
                            <span class="dac-nav-hamburger-top"></span> 
                            <span class="dac-nav-hamburger-mid"></span> 
                            <span class="dac-nav-hamburger-bot"></span>
                        </span>
                    </a>
                    <a class="dac-header-logo" href="../index.html">
                        <img class="dac-header-logo-image" src="../assets/images/logo.png" srcset="../assets/images/logo.png" width="32" height="32">STF Digital
                    </a>
                    <ul class="dac-header-tabs">
                        <li><a class="dac-header-tab selected" href="#">Desenvolvimento</a></li>
                    </ul>
                    <a class="dac-header-console-btn" href="https://github.com/supremotribunalfederal/stfdigital" target="_blank" > 
                        <img src="../assets/images/github-icon.png" srcset="../assets/images/github-icon.png" />
                        <span class="dac-visible-desktop-inline">Repositório</span>
                    </a>
                </div>
            <!--/.header-wrap.wrap-->
            </div>
        <!--/.header-->
        </header>
    
        <a name="navigation" tabindex="0" class="nav-start-marker">navigation</a>

        <nav class="dac-nav">
            <div class="dac-nav-dimmer" data-dac-toggle-nav=""></div>
            <div class="dac-nav-sidebar" data-swap="" data-dynamic="false" data-transition-speed="300" data-dac-nav="">
                <div data-swap-container="">
                    <a class="dac-nav-back-button dac-swap-section dac-up dac-active" tabindex="0" data-swap-button="" href="../index.html"> 
                        <i class="dac-sprite dac-nav-back"></i> 
                        <span class="dac-nav-back-title">Arquitetura</span>
                    </a>
    
                    <div class="dac-nav-sub dac-swap-section dac-right dac-active">
                        <ul id="nav">
                            <li class="nav-section expanded">
                                <div class="nav-section-header">
                                    <a href="#">Iniciando</a>
                                </div>
                                <ul style="display: block;">
                                    <li><a href="../iniciando/definicao.html">O que é o STF Digital</a></li>
                                    <li><a href="../iniciando/montagem.html">Monte seu Ambiente</a></li>
                                    <li><a href="../iniciando/demonstracao.html">Demonstração</a></li>
                                </ul>
                            </li>
                            </br>
                            <li class="nav-section expanded">
                                <div class="nav-section-header">
                                    <a href="#">Arquitetura</a>
                                </div>
                                <ul style="display: block;">
                                    <li><a href="../arquitetura/visao.html">Nossa Visão</a></li>
                                    <li><a href="../arquitetura/estrategia.html">Estratégia Arquitetural</a></li>
                                    <li><a href="../arquitetura/implantacao.html">Estratégia de Implantação</a></li>
                                </ul>
                            </li>
                            </br>
                            <li class="nav-section expanded">
                                <div class="nav-section-header">
                                    <a href="#">Padrões e Políticas</a>
                                </div>
                                <ul style="display: block;">
                                    <li><a href="../politicas/testes.html">Estratégia de Testes</a></li>
                                    <li><a href="../politicas/api.html">Gestão da API</a></li>
                                    <li><a href="../politicas/codigo-limpo.html">Código Limpo</a></li>
                                    <li><a href="../politicas/diretorios.html">Estrutura de diretórios</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
    
                </div>
            </div>
        </nav>

        <a name="top" tabindex="0"></a>
    
        <div class="wrap clearfix" id="body-content">
            <div class="content-header">
                <ul class="dac-header-crumbs dac-has-content">
                    <li class="dac-header-crumbs-item"><a class="dac-header-crumbs-link" href="#">Desenvolvimento</a></li>
                    <li class="dac-header-crumbs-item"><a class="dac-header-crumbs-link" href="#">Iniciando</a></li>
                    <li class="dac-header-crumbs-item"><a class="dac-header-crumbs-link" href="#">Monte seu Ambiente</a></li>
                </ol>
                <h1 itemprop="name">Monte seu Ambiente</h1>
            </div>
            <div id="jd-content">
                <div class="jd-descr" itemprop="articleBody">
					<p> Para a versão do guia para Docker Toolbox, clique <a href="./montagem-docker-toolbox.html">aqui</a><p>
                    <p>
                        <i>Usamos Maven, Docker, Eclipse e Visual Studio Code para trabalhar nos serviços do STF Digital.
                        Usamos Maven como ferramenta de construção, Docker para montar a infra local necessária,
                        Eclipse para trabalhar no código de front-end e Visual Studio Code para trabalhar no 
                        código de back-end.</i>
                    </p>

                    <p>    
                        <i>O tutorial abaixo foi criado para o Sistema Operacional Windows. Alguns passos foram documentados 
                        também para Linux. Siga os passos abaixo para deixar seu ambiente pronto para
                        começar a trabalhar. Caso encontre alguma dificuldade, entre em contato com Rodrigo Barreiros no 
                        e-mail rodrigo.barreiros@stf.jus.br.</i>
                    </p>

                    <h3 id="" style="padding-bottom: 0px;">Instale o JDK 8</h4>
                    <hr>

                    <p>
                    Digite javac -version e caso não tenha instalado a versão 8, baixe o <a target="_blank" href="http://www.oracle.com/technetwork/pt/java/javase/downloads/jdk8-downloads-2133151.html">Java JDK 8</a> e instale.
                    </p>
                        
                    <p>
                    Crie uma nova variável de ambiente chamada JAVA_HOME com o endereço da instalação do JDK (ex: C:\Program Files\Java\jdk1.8.0_91)
                    Adicione na variável Path ";%JAVA_HOME%\bin"
                    </p>
                        
                    <p>
                    Execute o comando javac - version para verficar se a instalação foi realizada com sucesso.
                    </p>
                    
                    <h3 id="comece" style="padding-bottom: 0px;">Baixe a IDE recomendada: Spring Tool Suite</h3>
                    <hr>

                    <p>    
                        Baixe o <a target="_blank" href="https://spring.io/tools">Eclipse STS (Spring Tool Suite)</a>. 
                        Enquanto o download é realizado, continue configurando o ambiente...
                    </p>

                    <h3 id="comece" style="padding-bottom: 0px;">Instale o Docker Community Edition e o Git</h3>
                    <hr>
                    


                    <ol>
                        <li> Faça download do <a target="_blank" href="https://www.docker.com/community-edition">Docker Community Edition</a></li>
                        <li> Para ativar o Hyper-V vá em Painel de Controle\Programas </li>
                        <li> Clique em Ativar ou destivar recursos do Windows</li>
                        <li> Marque Hyper-V e clique em OK, após fazer isso o computador irá reniciar</li>
                        <li> Feito isso execute o Docker for Windows install</li>
                        <li> Clique em Close, ao fazer isso a máquina irá deslogar</li>
                        <li> Realize login</li>
                        <li> Para testar se está tudo funcionando corretamente digite o comando abaixo</li>
                        
                    </ol> 
                    <p>
                        <pre class="prettyprint"><span class="str">$ </span><span class="pln">docker ps</span></pre>                        
                    </p>

                    <h4 id="comece" style="padding-bottom: 0px;">Aumente a memoria do Docker </h4>
                    <hr>

                    <ol>
                        <li> Clique em Mostrar ícones ocultos no lado direito da tela ao lado do ícone de Acesso à Internet</li>
                        <li> Clique com o botão esquerdo do mouse no ícone do docker(uma baleia)</li>
                        <li> Clique em Settings</li>
                        <li> Clique em Advanced</li>
                        <li> Aumente a memória para 3072 e clique em Apply</li>
                    </ol> 
                    
                    <h4 id="comece" style="padding-bottom: 0px;">Atualize as imagens dos outros contextos a partir do Docker Hub/Registro Corporativo</h4>
                    <hr>

                    <p>    
                        Se ainda não estiver logado no registry execute o seguinte comando no Windows PowerShell e realize login usando o usuário e senha de rede:
                    </p>

                    <p>
                        <pre class="prettyprint"><span class="str">$ </span><span class="pln">docker login registry.stf.jus.br</span></pre>                        
                    </p>

                    <h4 id="comece" style="padding-bottom: 0px;">Configure seus hosts</h4>
                    <hr>
                        
                    <p>
                        Copie o endereço de IP e, no Windows, abra o arquivo                        
                    </p>
                        
                    <p>
                        <pre class="prettyprint"><span class="pln">C:\Windows\System32\drivers\etc\hosts</span></pre>                        
                    </p>
                        
                    <p>
                        E adicione as linhas abaixo:
                    </p>
                        
                    <p>
                        <pre class="prettyprint"><span class="pln">127.0.0.1  docker discovery cassandra rabbit gateway documents oracle</span>
<span class="pln">127.0.0.1  modulos redis identidades elk onlyoffice elasticsearch</span></pre>
                    </p>
                        
                    <p>
                        No Linux, isso pode ser feito adicionando uma entrada no arquivo `/etc/hosts`, como no exemplo abaixo 
                    </p>
                        
                    <p>
                        <pre class="prettyprint"><span class="pln">127.0.0.1  docker discovery cassandra rabbit gateway documents oracle</span>
<span class="pln">127.0.0.1  modulos redis identidades elk onlyoffice elasticsearch</span></pre>
                    </p>
                        
                    <p>
                        Você poderá confirmar se esse relacionamento está funcional executando o comando `ping` contra o alias criado.
                    </p>
                        
                    <p>
                        <pre class="prettyprint"><span class="str">$ </span><span class="pln">ping docker</span></br><br><span class="pln">Disparando docker [127.0.0.1] com 32 bytes de dados:</span></br><span class="pln">Resposta de 127.0.0.1: bytes=32 tempo<1ms TTL=128</span></br><span class="pln">Resposta de 127.0.0.1: bytes=32 tempo<1ms TTL=128</span></br><span class="pln">Resposta de 127.0.0.1: bytes=32 tempo<1ms TTL=128</span></br><span class="pln">Resposta de 127.0.0.1: bytes=32 tempo<1ms TTL=128</span></1ms></pre>
                    </p>

                    <p>
                    Você também precisará ter a versão mais recente do  <a href="https://nodejs.org/en/" target="_blank">NodeJS (já inclui NPM)</a>. Sugerimos a versão 8.9.4 LTS. 
                    </p>
                        
                    <p>
                    Após instalar o NodeJs abra o Prompt de comando ou qualquer outro terminal da sua preferência e execute os seguintes comandos para verificar se o NodeJS e o NPM estão instalados corretamente: 
                    </p>
                        
                    <p>
                        <pre class="prettyprint"><span class="pln">node -v</span></br><span class="pln">npm -v</span></pre>                        
                    </p>
                        
                    <h4 id="" style="padding-bottom: 0px;">Instale o Gulp</h4>
                    <hr>
                    
                    <p>
                    Execute o seguinte comando para instalar o gulp globalmente:
                    </p>

                    <p>
                        <pre class="prettyprint"><span class="str">$ </span><span class="pln">npm install -g gulp </span></pre>                        
                    </p>

                    <h3 id="" style="padding-bottom: 0px;">Configure o Eclipse para começar a codificar</h3>
                    <hr>

                    <p>
                    Usamos <a target="_blank" href="https://spring.io/tools">Spring Tool Suite </a> como IDE. Certifique-se que você tem a última versão. 
                    Você também precisará instalar plugin Typescript.java.
                    </p>

                    <h4 id="" style="padding-bottom: 0px;">Instalando o reconhecimento da sintaxe do Typescript</h4>
                    <hr>

                    <p>
                        Apesar de recomendarmos o Visual Studio Code para codificar o front-end, também há a opção de instalar o seguinte plugin
                        para o Eclipse, caso prefira utilizar apenas o Eclipse. (Observação: esse plugin ainda não suporta validação de padrão de codificação
                        em tempo de codificação)
                    </p>
                    <p>
                    Para instalar o reconhecimento da sintaxe do Typescript <a href="https://github.com/angelozerr/typescript.java/wiki/Installation%20Update%20Site" target="_blank">Typescript.java</a> siga os passos abaixo:
                    </p>

                    <ol>
                        <li> Abra o Eclipse> clique em Help > Install New Software... > ADD.</li>

                        <li> Inclua em location site o link do typescript.java "http://oss.opensagres.fr/typescript.ide/1.3.0/". O nome pode ser Typescript.java Update site.</li>

                        <li> Marque todas as opções e clique em Next, Next, Finish.</li>
                    </ol>
                    
                    <h4 id="" style="padding-bottom: 0px;">Alterando a codificação padrão do Eclipse</h4>
                    <hr>

                    <p>
                        O Eclipse, por padrão, cria projetos com codificação ISO-8859-1 para seus arquivos. O STF Digital utiliza, por questões de
                        padronização, a codificação UTF-8. Por isso, é necessário alterar essas codificação no Eclipse. Para isso, execute os passos a seguir:
                    </p>

                    <ol>
                        <li> Abra o Eclipse,</li>
                        <li> Clique em Window/Preferences</li>
                        <li> Clique em General/Workspace</li>
                        <li> Selecione o Text file encoding: Other</li>
                        <li> Selecione UTF-8</li>
                        <li> Clique Apply and Close</li>
                    </ol>

                    <h4 id="" style="padding-bottom: 0px;">Ativando a sincronização do Eclipse com arquivos alterados externamente</h4>
                    <hr>

                    <p>
                        Como utilizamos o Gulp para construção de front-end e o Eclipse não monitora por padrão arquivos alterados externamente,
                        é necessário ativar essa opção no Eclipse para que o código front-end servido pelo back-end esteja sempre atualizado.
                        Para ativar essa opção no Eclipse, execute os passos a seguir:
                    </p>

                    <ol>
                        <li> Abra o Eclipse,</li>
                        <li> Clique em Window/Preferences</li>
                        <li> Clique em General/Workspace</li>
                        <li> Selecione "Refresh using native hooks or polling</li>
                        <li> Clique em Apply and Close</li>
                    </ol>

                    <h3 id="" style="padding-bottom: 0px;">Instale o Visual Studio Code e plugins</h3>
                    <hr>

                    <p>
                    Usamos o <a target="_blank" href="https://code.visualstudio.com">Visual Studio Code</a> como IDE para front-end. Certifique-se que você tem a última versão. 
                    Você também precisará instalar os seguintes plugins:
                    </p>
                    
                    <ol>
                        <li><a href="https://marketplace.visualstudio.com/items?itemName=eg2.tslint" target="_blank">TSLint</a>, que é utilizado para verificar se o código está de acordo
                        com o <a href="../politicas/codigo-limpo.html#padrao-codificao-frontend">padrão de codificação de front-end</a> em tempo de codificação</li>
                    </ol>
                    
                    <h3 id="desenvolvendo-contexto-especifico">Desenvolvendo para um contexto específico</h3>
                    <hr>
                    
                    <p>Quando uma equipe está desenvolvendo em apenas um contexto, eles não precisam ficar construindo esses contextos localmente. Como
                    as imagens docker dos outros contextos já são construídas na integração contínua e os desenvolvedores <i>normalmente</i>
                    não precisam alterar nada nessas imagens, eles podem baixá-las diretamente de um
                    registro docker. Nesta seção estão os procedimentos para utilizar essa abordagem de desenvolvimento.
                    
                    <h4 id="desenvolvendo-contexto-baixar" style="padding-bottom: 0px;">Baixe o repositório do contexto</h4>
                    <hr>

                    <p>    
                        Abra o <b>Git Bash</b> e na sua pasta de preferência (ex: /c/dev) , para baixar o repositório 
                        e execute os comandos abaixo:
                    </p>
                    
                    <p>
                        <pre class="prettyprint"><span class="str">$ </span><span class="pln">git clone https://gitlab.com/supremotribunalfederal/stfdigital-autuacao-registro</span>
<span class="str">$ </span><span class="pln">cd stfdigital-autuacao-registro</span></pre>
                    </p>
                    
                    <h4 id="" style="padding-bottom: 0px;">Atualize as imagens dos outros contextos a partir do Docker Hub/Registro Corporativo</h4>
                    Para desenvolver para um contexto específico, é recomendável manter sempre as imagens locais dos outros contextos sempre atualizadas.
                    Para atualizá-las, basta executar o comando logo abaixo. Execute esse comando com frequência diária pelo menos ou quando for notificado
                    (via Slack, por exemplo) de que uma imagem foi atualizada. (É necessário ter executado antes o comando npm install a partir do diretório
                    do projeto atual para que o diretório shared, que é referenciado no docker-compose.yml seja baixado para a máquina.)
                    <p>
                        <pre class="prettyprint"><span class="str">$ </span><span class="pln">docker-compose pull</span></pre>                        
                    </p>
                    
                    <p>Depois de executar o comando acima, é preciso sempre executar o comando da próxima seção para que os serviços em execução
                    estejam sempre atualizados.</p>
                    
                    <h4 id="" style="padding-bottom: 0px;">Execute os containers docker dos outros contextos</h4>
                    <hr>
                    
                    <p>
                        <pre class="prettyprint"><span class="str">$ </span><span class="pln">docker-compose up -d</span></pre>                        
                    </p>

                    <p>
                    A medida que os serviços forem iniciados, eles serão registrados automaticamente no serviço de discovery. Acesse `http://discovery:8761` para acompanhar o registro dos serviços. Quando todos estiverem registrados, você deverá ver a tabela como no exemplo abaixo:
                    </p>

                    <div>
                        <img src="assets/images/discovery.png" width="900">
                    </div>
                    
                    <h4 id="eclipse-importacao" style="padding-bottom: 0px;">Importe o projeto no Eclipse</h4>
                    <hr>

                    <p>Importe os projetos no Eclipse com os seguintes passos:</p>
                    <ol>
                        <li> Clique com o botão direito na view Package Explorer</li>
                        <li> Clique em Import</li>
                        <li> Clique em Maven/Existing Maven Projects</li>
                        <li> Clique em Next</li>
                        <li> Clique em Browse</li>
                        <li> Selecione o diretório do projeto (ex: stfdigital-autuacao-registro)</li>
                        <li> Clique em Finish`é normal demorar na primeira execução`</li>
                    </ol>
                    
                    <h4 id="eclipse-profile" style="padding-bottom: 0px;">Configure o profile da aplicação</h4>
                    <hr>
                    <ol>
                        <li>Abra a view Boot Dashboard</li>
                        <li>Clique com o botão direito no projeto do contexto (autuacao-registro, por exemplo)</li>
                        <li>Clique em Open Config</li>
                        <li>Preencha o campo Profile com <code>development</code></li>
                        <li>Clique em Apply, depois em Close</li>
                    </ol>  

                    <h4 id="eclipse-profile" style="padding-bottom: 0px;">Baixe os artefatos do repositório remoto para o repositório local utilizando Maven</h4>
                    <hr>
                    <ol>
                        <li>Acesse <a href="http://build/artifactory" target="_blank">http://build/artifactory</a></li>
                        <li>Realize login com seu usuário e senha de rede</li>
                        <li>Clique no seu usuário no canto superior direito da tela</li>
                        <li>Preencha o campo Current Password com a sua senha de rede e clique em Unlock</li>
                        <li>Copie o trecho de código que irá aparecer</li>
                        <li>Vá em C:\Users\augusto.s.castro\.m2</li>
                        <li>Abra o arquivo settings.xml no Notepad++</li>
                        <li>Cole o trecho de código entre a tag servers</li>
                        <li>Substitua ${server-id} por repo-unificado na tag id</li>
                        <li>Abra o Spring Tool Suite</li>
                        <li>Clique com o botao direiro do mouse na raiz do projeto(autuacao-registro, por exemplo)</li>
                        <li>Clique em Maven/Update Project</li>
                        <li>Selecione o projeto e clique em OK</li>
                    </ol>

                    <h4 id="eclipse-executar" style="padding-bottom: 0px;">Execute a aplicação back-end pelo Eclipse</h4>
                    <hr>
                    <p>
                        Antes de realizar esse passo, é necessário verificar que o contexto <code>discovery</code> já tenha terminado
                        de subir. Isso é necessário pois as configurações dos contextos estão centralizadas no discovery.
                        Para verificar isso acesse <a href="http://discovery:8761">http://discovery:8761</a>. Se essa página carregar,
                        significa que ele já está rodando com sucesso e os passos abaixo já podem ser executados.
                    </p>
                    <ol>
                        <li>Abra a view Boot Dashboard</li>
                        <li>Clique com o botão esquerdo no projeto do contexto (autuacao-registro, por exemplo)</li>
                        <li>Clique em (Re)rebug</li>
                    </ol>
                    
                    <h4 id="" style="padding-bottom: 0px;">Instale as dependências de front-end do projeto</h4>
                    <hr>
                    
                    <p>
                        Execute o seguinte comando a partir do diretório do projeto para instalar as dependências de front-end:
                    <p>
                    
                    <p>
                        <pre class="prettyprint"><span class="str">$ </span><span class="pln">npm install</span></pre>
                    </p>
                    
                    <h4 id="eclipse-build-front-end" style="padding-bottom: 0px;">Execute a construção e <i>watch</i> do código do front-end</h4>
                    <hr>
                    <ol>
                        <li>Abra um terminal Git Bash</li>
                        <li>Acesse a raiz da aplicação (por exemplo, stfdigital/autuacao/recebimento)</li>
                        <li>Execute um dos seguintes comandos:
                        <p>
                        Apenas monitora e constrói os recursos de frontend
                        </p>
                        <pre class="prettyprint"><span class="str">$ </span><span class="pln">gulp watch</span></pre>
                        <p>
                        Monitora os recursos de frontend e roda um browsersync, recarregando a página toda vez que uma alteração for feita.
                        </p>
                        <pre class="prettyprint"><span class="str">$ </span><span class="pln">gulp serve:dev</span></pre>
                        </li>
                    </ol>
                    
                    <h4 id="eclipse-build-front-end" style="padding-bottom: 0px;">Acesse a aplicação pelo browser</h4>
                    <hr>
                    
                    <p>
                        Acesse a aplicação no browser pelo endereço <a href="http://docker:8443" target="_blank">http://docker:8443</a> . Caso tenha iniciado a construção de front-end
                        pelo comando <code>gulp serve:dev</code>, poderá acessar pelo endereço <a href="http://localhost:3000" target="_blank">http://localhost:3000</a>, para ter o browsersync
                        sincronizando os recursos de front-end.
                    </p>
                </div>   
            </div>
            <!-- end jd-content -->
        </div>
        <!--/#body-content-->
    </body>
</html>
